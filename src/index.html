<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mind Palace - kenefe's Knowledge Graph</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Source+Serif+4:opsz,wght@8..60,300;8..60,400;8..60,500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-cream: #FAFAF8;
      --bg-warm: #F4F3F0;
      --bg-card: #FFFFFF;
      --graph-bg: #1a1d23;
      --graph-bg2: #12141a;
      --text-primary: #1a1a1a;
      --text-secondary: #555;
      --text-muted: #999;
      --border: #e8e8e6;
      --border-light: #f0efed;
      --accent: #6366f1;
      --accent-warm: #c0845e;
      --accent-sage: #6b9080;
      --accent-slate: #5a7a9b;
      --accent-plum: #9b6b8a;
      --accent-gold: #b8a060;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
      --radius: 10px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { overflow-x: hidden; max-width: 100vw; }
    body {
      font-family: 'Source Serif 4', Georgia, serif;
      background: var(--bg-cream);
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 15px;
    }
    #app { display: flex; height: 100vh; overflow: hidden; max-width: 100vw; }

    /* === Graph === */
    #graph-container {
      flex: 1;
      position: relative;
      background: var(--graph-bg);
      background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.03) 1px, transparent 0),
                        radial-gradient(ellipse at 30% 50%, rgba(99,102,241,0.08) 0%, transparent 60%),
                        radial-gradient(ellipse at 70% 30%, rgba(192,132,94,0.05) 0%, transparent 50%);
      background-size: 24px 24px, 100% 100%, 100% 100%;
    }
    #graph { width: 100%; height: 100%; }

    /* === Sidebar === */
    #sidebar {
      width: 440px; min-width: 340px; max-width: 70vw;
      background: var(--bg-cream);
      display: flex; flex-direction: column;
      overflow: hidden; position: relative;
      border-left: 1px solid var(--border);
    }
    #resize-handle {
      position: absolute; left: 0; top: 0; bottom: 0;
      width: 5px; cursor: ew-resize; background: transparent; z-index: 10;
    }
    #resize-handle:hover { background: var(--accent); opacity: 0.3; }

    .sidebar-header {
      padding: 28px 28px 20px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-header h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.5rem; font-weight: 500;
      letter-spacing: -0.02em; margin-bottom: 2px;
    }
    .sidebar-header p {
      font-size: 0.8rem; color: var(--text-muted); font-style: italic;
    }

    #search-box { padding: 16px 28px; border-bottom: 1px solid var(--border); }
    #search-box input {
      width: 100%; padding: 10px 14px;
      background: var(--bg-warm); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-primary);
      font-family: inherit; font-size: 0.88rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #search-box input:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.08);
    }
    #search-box input::placeholder { color: var(--text-muted); }

    #themes-panel { padding: 16px 28px; border-bottom: 1px solid var(--border); }
    #themes-panel h3 {
      font-size: 0.65rem; color: var(--text-muted);
      margin-bottom: 10px; text-transform: uppercase;
      letter-spacing: 0.12em; font-weight: 400;
    }
    .theme-tag {
      display: inline-block; padding: 5px 14px; margin: 3px;
      border-radius: 20px; font-size: 0.78rem; cursor: pointer;
      transition: all 0.2s ease; border: 1px solid var(--border);
      background: transparent; color: var(--text-secondary);
    }
    .theme-tag:hover {
      border-color: var(--text-muted); background: var(--bg-warm);
    }
    .theme-tag.active {
      background: var(--text-primary); color: #fff;
      border-color: var(--text-primary);
    }

    #detail-panel {
      flex: 1; overflow-y: auto; overflow-x: hidden;
      padding: 20px 24px; min-width: 0;
    }
    #detail-panel::-webkit-scrollbar { width: 4px; }
    #detail-panel::-webkit-scrollbar-track { background: transparent; }
    #detail-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 14px; min-width: 0;
    }

    .detail-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 20px 22px;
      transition: all 0.25s ease;
      overflow: hidden; overflow-wrap: break-word;
      word-break: break-word; min-width: 0;
      box-shadow: var(--shadow-sm);
    }
    .detail-card:hover {
      border-color: var(--border);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    .detail-card h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 0.98rem; font-weight: 500;
      margin-bottom: 8px; line-height: 1.45;
    }
    .detail-card h2 a {
      color: var(--text-primary); text-decoration: none;
      transition: color 0.2s;
    }
    .detail-card h2 a:hover { color: var(--accent); }
    .detail-card .note {
      font-size: 0.84rem; color: var(--text-secondary);
      line-height: 1.7; margin-bottom: 12px;
    }
    .detail-card .meta { font-size: 0.73rem; color: var(--text-muted); }
    .detail-card .tags { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 4px; }
    .detail-card .tag {
      display: inline-block; padding: 2px 8px;
      background: var(--bg-warm); border: none;
      border-radius: 4px; font-size: 0.68rem;
      color: var(--text-muted);
    }

    .highlights { margin-bottom: 12px; }
    .highlight-item {
      display: block; padding: 10px 14px;
      background: var(--bg-warm);
      border-left: 2px solid var(--accent-warm);
      border-radius: 0 6px 6px 0;
      margin-bottom: 6px; font-size: 0.84rem;
      color: var(--text-secondary); line-height: 1.6;
      font-style: italic; overflow-wrap: break-word;
    }

    .related-section {
      margin-top: 14px; padding-top: 14px;
      border-top: 1px solid var(--border-light);
    }
    .related-section h4 {
      font-size: 0.68rem; color: var(--text-muted);
      margin-bottom: 8px; text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .related-item {
      font-size: 0.8rem; padding: 3px 0;
      color: var(--text-secondary); line-height: 1.5;
      overflow-wrap: break-word;
    }
    .related-item a {
      color: var(--accent); text-decoration: none;
      font-weight: 500; transition: opacity 0.2s;
    }
    .related-item a:hover { opacity: 0.7; }
    .related-desc { color: var(--text-muted); font-size: 0.73rem; }

    .breadcrumb {
      margin-bottom: 16px; padding-bottom: 12px;
      border-bottom: 1px solid var(--border-light); font-size: 0.8rem;
    }
    .bc-link { color: var(--accent); cursor: pointer; }
    .bc-link:hover { opacity: 0.7; }
    .bc-sep { color: var(--text-muted); margin: 0 4px; }
    .bc-current { color: var(--text-secondary); }

    .cluster-header h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.3rem; margin-bottom: 4px;
    }

    /* === Graph nodes === */
    .node { cursor: pointer; }
    .node circle { transition: all 0.25s ease; }
    .node:hover circle { filter: brightness(1.2); }
    .node.selected circle { stroke: #fff; stroke-width: 2px; }
    .node.highlighted circle { stroke: var(--accent); stroke-width: 3px; filter: brightness(1.3); }
    .node.dimmed circle { opacity: 0.15; }
    .node.dimmed text { opacity: 0.15; }
    .link { stroke: rgba(255,255,255,0.08); }
    .node-label {
      font-family: 'Source Serif 4', serif;
      font-size: 9px; fill: rgba(255,255,255,0.5);
      pointer-events: none;
    }
    .theme-label {
      font-size: 11px; fill: rgba(255,255,255,0.85);
      font-weight: 500;
    }

    /* === Mobile nav === */
    .mobile-nav {
      display: none; position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--bg-cream); border-top: 1px solid var(--border);
      z-index: 100; padding: 10px 0;
      padding-bottom: env(safe-area-inset-bottom, 10px);
    }
    .mobile-nav-inner { display: flex; justify-content: center; gap: 32px; }
    .mobile-nav button {
      background: none; border: none; color: var(--text-muted);
      font-family: inherit; font-size: 0.85rem; padding: 8px 16px; cursor: pointer;
    }
    .mobile-nav button.active {
      color: var(--text-primary); border-bottom: 1px solid var(--text-primary);
    }

    @media (max-width: 768px) {
      #app { flex-direction: column; overflow: hidden; max-width: 100vw; }
      #graph-container { height: 100vh; display: none; border-right: none; min-width: 0; }
      #graph-container.active { display: block; }
      #sidebar { width: 100% !important; max-width: 100%; min-width: 0; height: 100vh; display: none; overflow-y: auto; overflow-x: hidden; border-left: none; }
      #sidebar.active { display: flex; }
      .mobile-nav { display: block; }
      body { padding-bottom: 56px; }
      #resize-handle { display: none; }
      .sidebar-header { padding: 16px 20px 12px; }
      .sidebar-header h1 { font-size: 1.3rem; }
      .sidebar-header p { font-size: 0.75rem; margin-bottom: 0; }
      #search-box { padding: 8px 20px; }
      #search-box input { padding: 10px 14px; font-size: 0.85rem; }
      #themes-panel { padding: 8px 20px 12px; overflow: hidden; }
      #themes-panel h3 { margin-bottom: 8px; font-size: 0.65rem; }
      #themes-panel div { display: flex; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; gap: 6px; padding-bottom: 6px; scrollbar-width: none; }
      #themes-panel div::-webkit-scrollbar { display: none; }
      .theme-tag { padding: 4px 10px; font-size: 0.75rem; margin: 0; flex-shrink: 0; white-space: nowrap; }
      #detail-panel { padding: 12px 16px; }
      .cards-grid { grid-template-columns: 1fr; gap: 12px; }
      .detail-card { padding: 16px; }
      .detail-card h2 { font-size: 0.95rem; }
      .detail-card h2 a { word-break: break-all; }
      .detail-card .note { font-size: 0.8rem; }
    }
</style>
</head>
<body>
<div id="app">
  <div id="graph-container">
    <svg id="graph"></svg>
  </div>
  <div id="sidebar">
    <div id="resize-handle"></div>
    <div class="sidebar-header">
      <h1>Mind Palace</h1>
      <p>A curated collection of thoughts</p>
    </div>
    <div id="search-box"></div>
    <div id="themes-panel"></div>
    <div id="detail-panel"></div>
  </div>
</div>
<nav class="mobile-nav">
  <div class="mobile-nav-inner">
    <button id="nav-list" class="active">Index</button>
    <button id="nav-graph">Graph</button>
  </div>
</nav>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const DATA = __DATA__;
let selectedNode = null;
let activeTheme = null;
let graphNodes = null; // ÂÖ®Â±ÄÂºïÁî®ÔºåÁî®‰∫é hover ËÅîÂä®
document.addEventListener('DOMContentLoaded', init);

function init() {
  renderSearch();
  renderThemes();
  renderGraph();
  renderList();
  initMobileNav();
  initResize();
}

function initResize() {
  const handle = document.getElementById('resize-handle');
  const sidebar = document.getElementById('sidebar');
  if (!handle || !sidebar) return;
  let isResizing = false;
  handle.addEventListener('mousedown', (e) => { isResizing = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
  document.addEventListener('mousemove', (e) => { if (!isResizing) return; const w = window.innerWidth - e.clientX; if (w >= 320 && w <= window.innerWidth * 0.7) sidebar.style.width = w + 'px'; });
  document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = ''; });
}

function initMobileNav() {
  const navList = document.getElementById('nav-list');
  const navGraph = document.getElementById('nav-graph');
  const sidebar = document.getElementById('sidebar');
  const graphContainer = document.getElementById('graph-container');
  if (!navList || !navGraph) return;
  sidebar.classList.add('active');
  navList.addEventListener('click', () => {
    sidebar.classList.add('active'); graphContainer.classList.remove('active');
    navList.classList.add('active'); navGraph.classList.remove('active');
  });
  navGraph.addEventListener('click', () => {
    graphContainer.classList.add('active'); sidebar.classList.remove('active');
    navGraph.classList.add('active'); navList.classList.remove('active');
    setTimeout(renderGraph, 100);
  });
}

function renderSearch() {
  const box = document.getElementById('search-box');
  box.innerHTML = `<input type="text" placeholder="Search..." id="search-input">`;
  document.getElementById('search-input').addEventListener('input', (e) => renderList(e.target.value.toLowerCase()));
}

function renderThemes() {
  const panel = document.getElementById('themes-panel');
  let html = '<h3>Themes</h3><div>';
  DATA.themes.forEach(t => {
    html += `<span class="theme-tag" data-id="${t.id}">${t.name}</span>`;
  });
  html += '</div>';
  panel.innerHTML = html;
  panel.querySelectorAll('.theme-tag').forEach(el => {
    el.addEventListener('click', () => {
      const id = el.dataset.id;
      if (activeTheme === id) { activeTheme = null; el.classList.remove('active'); }
      else { panel.querySelectorAll('.theme-tag').forEach(e => e.classList.remove('active')); activeTheme = id; el.classList.add('active'); }
      renderList();
    });
  });
}

function renderList(query = '') {
  const panel = document.getElementById('detail-panel');
  let items = DATA.items;
  if (activeTheme) items = items.filter(i => i.themes && i.themes.includes(activeTheme));
  if (query) items = items.filter(i => (i.title || '').toLowerCase().includes(query) || (i.note || '').toLowerCase().includes(query) || i.tags.some(t => t.toLowerCase().includes(query)));
  let html = '<div class="cards-grid">';
  items.forEach(item => { html += renderCard(item); });
  html += '</div>';
  panel.innerHTML = items.length ? html : '<p style="color:var(--text-muted)">No results</p>';
}

function renderCard(item, compact = false) {
  const date = new Date(item.created).toLocaleDateString('zh-CN');
  const tags = item.tags.map(t => `<span class="tag">${t}</span>`).join('');
  let highlightsHtml = '';
  if (!compact && item.highlights_text && item.highlights_text.length > 0) {
    highlightsHtml = '<div class="highlights">';
    item.highlights_text.forEach(h => { highlightsHtml += `<span class="highlight-item">${h}</span>`; });
    highlightsHtml += '</div>';
  }
  let relatedHtml = '';
  if (item.related && item.related.length > 0) {
    relatedHtml = '<div class="related-section"><h4>üìé Áõ∏ÂÖ≥ÈòÖËØª</h4>';
    item.related.forEach(r => {
      // Êü•Êâæ Mind Palace ÂÜÖÊòØÂê¶ÊúâÂØπÂ∫îÊñáÁ´†
      const internal = DATA.items.find(i => i.link === r.url);
      if (internal) {
        relatedHtml += `<div class="related-item"><a href="javascript:void(0)" onclick="navigateTo(${internal._id})">${r.title}</a><span class="related-desc"> - ${r.desc}</span></div>`;
      } else {
        relatedHtml += `<div class="related-item"><a href="${r.url}" target="_blank">${r.title}</a><span class="related-desc"> - ${r.desc}</span></div>`;
      }
    });
    relatedHtml += '</div>';
  }
  // ÂêåÊòüÁ≥ªÊñáÁ´†
  let galaxyHtml = '';
  if (!compact) {
    const itemGalaxies = (DATA.galaxies || []).filter(g => g.members.includes(item._id));
    if (itemGalaxies.length > 0) {
      galaxyHtml = '<div class="related-section"><h4>üåå ÂêåÊòüÁ≥ª</h4>';
      itemGalaxies.forEach(gal => {
        galaxyHtml += `<div class="galaxy-link" onclick="navigateToGalaxy('${gal.id}')" style="cursor:pointer;margin-bottom:4px"><span style="color:${gal.color};font-weight:600">‚óè ${gal.name}</span> <span class="related-desc">(${gal.count})</span></div>`;
      });
      galaxyHtml += '</div>';
    }
  }
  return `<div class="detail-card" data-id="${item._id}" onmouseenter="highlightNode(${item._id})" onmouseleave="unhighlightNode()">
    <h2><a href="${item.link}" target="_blank">${item.title || item.link}</a></h2>
    ${highlightsHtml}
    ${item.note ? `<div class="note">${item.note}</div>` : ''}
    <div class="meta">${item.domain} ¬∑ ${date}</div>
    <div class="tags">${tags}</div>
    ${relatedHtml}
    ${galaxyHtml}
  </div>`;
}

// Navigation stack for breadcrumb
let navStack = [];

function pushNav(label, fn) {
  navStack.push({ label, fn });
  renderBreadcrumb();
}

function renderBreadcrumb() {
  const panel = document.getElementById('detail-panel');
  if (navStack.length <= 1) return;
  let bc = '<div class="breadcrumb">';
  navStack.forEach((item, i) => {
    if (i < navStack.length - 1) {
      bc += `<span class="bc-link" onclick="navTo(${i})">${item.label}</span><span class="bc-sep"> ‚Ä∫ </span>`;
    } else {
      bc += `<span class="bc-current">${item.label}</span>`;
    }
  });
  bc += '</div>';
  panel.insertAdjacentHTML('afterbegin', bc);
}

function navTo(idx) {
  navStack = navStack.slice(0, idx + 1);
  navStack[idx].fn();
}

function navigateTo(itemId) {
  const item = DATA.items.find(i => i._id === itemId);
  if (!item) return;
  pushNav(item.title ? item.title.slice(0, 20) : 'Article', () => showDetailDeep(item));
  showDetailDeep(item);
}

function navigateToGalaxy(galaxyId) {
  const gal = (DATA.galaxies || []).find(g => g.id === galaxyId);
  if (!gal) return;
  pushNav(gal.name, () => showGalaxyDeep(gal));
  showGalaxyDeep(gal);
}

function showDetailDeep(item) {
  const panel = document.getElementById('detail-panel');
  let html = renderCard(item);

  // ÊâæÂêåÊòüÁ≥ªÁöÑÂÖ∂‰ªñÊñáÁ´†
  const itemGalaxies = (DATA.galaxies || []).filter(g => g.members.includes(item._id));
  const sameGalaxyItems = new Set();
  itemGalaxies.forEach(g => g.members.forEach(id => { if (id !== item._id) sameGalaxyItems.add(id); }));

  if (sameGalaxyItems.size > 0) {
    html += '<div style="margin-top:20px"><h3 style="font-family:Playfair Display,serif;font-size:1rem;margin-bottom:12px;color:var(--text-secondary)">ÂêåËØùÈ¢òÊñáÁ´†</h3><div class="cards-grid">';
    [...sameGalaxyItems].slice(0, 6).forEach(id => {
      const other = DATA.items.find(i => i._id === id);
      if (other) html += renderCard(other, true);
    });
    html += '</div></div>';
  }

  panel.innerHTML = html;
  renderBreadcrumb();
}

function showGalaxyDeep(gal) {
  const panel = document.getElementById('detail-panel');
  const items = DATA.items.filter(i => gal.members.includes(i._id));

  // ÊâæÊ°•Êé•Âà∞ÁöÑÂÖ∂‰ªñÊòüÁ≥ª
  const bridgedGalaxies = (DATA.bridges || [])
    .filter(b => b.source === gal.id || b.target === gal.id)
    .map(b => {
      const otherId = b.source === gal.id ? b.target : b.source;
      const other = (DATA.galaxies || []).find(g => g.id === otherId);
      return other ? { ...other, shared: b.strength } : null;
    }).filter(Boolean);

  let html = `<div class="cluster-header">
    <h2 style="color:${gal.color}">${gal.name}</h2>
    <p style="color:var(--text-muted);margin-bottom:8px">${items.length} articles</p>`;

  if (bridgedGalaxies.length > 0) {
    html += '<div style="margin-bottom:16px">';
    bridgedGalaxies.forEach(bg => {
      html += `<span class="galaxy-bridge-tag" onclick="navigateToGalaxy('${bg.id}')" style="cursor:pointer;display:inline-block;padding:4px 12px;margin:3px;border-radius:20px;font-size:0.8rem;border:1px solid ${bg.color};color:${bg.color}">‚Üî ${bg.name} (${bg.shared})</span>`;
    });
    html += '</div>';
  }

  html += '</div><div class="cards-grid">';
  items.forEach(item => { html += renderCard(item, true); });
  html += '</div>';
  panel.innerHTML = html;
  renderBreadcrumb();
}

function showDetail(item) {
  navStack = [{ label: 'All', fn: () => { navStack = []; renderList(); } }];
  pushNav(item.title ? item.title.slice(0, 20) : 'Article', () => showDetailDeep(item));
  showDetailDeep(item);
}

function highlightNode(itemId) {
  if (!graphNodes) return;
  const nodeId = 'item-' + itemId;
  const item = DATA.items.find(i => i._id === itemId);
  const themeIds = item?.themes || [];

  // È´ò‰∫Æ‰π¶Á≠æËäÇÁÇπÂíåÂØπÂ∫îÁöÑ‰∏ªÈ¢òËäÇÁÇπ
  graphNodes.classed('highlighted', d => d.id === nodeId || (d.isTheme && themeIds.includes(d.id)));
  graphNodes.classed('dimmed', d => d.id !== nodeId && !d.isTheme);
}

function unhighlightNode() {
  if (!graphNodes) return;
  graphNodes.classed('highlighted', false);
  graphNodes.classed('dimmed', false);
}

function showThemeDetail(theme, items) {
  navStack = [{ label: 'All', fn: () => { navStack = []; renderList(); } }];
  pushNav(theme.name, () => showGalaxyDeep(theme));
  showGalaxyDeep(theme);
}

function renderGraph() {
  const container = document.getElementById('graph-container');
  const width = container.clientWidth;
  const height = container.clientHeight;
  const svg = d3.select('#graph').attr('width', width).attr('height', height);
  svg.selectAll('*').remove();

  // Defs for glow effect
  const defs = svg.append('defs');
  const filter = defs.append('filter').attr('id', 'glow').attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
  filter.append('feGaussianBlur').attr('stdDeviation', '3').attr('result', 'blur');
  filter.append('feComposite').attr('in', 'blur').attr('in2', 'SourceGraphic').attr('operator', 'over');

  const glowStrong = defs.append('filter').attr('id', 'glow-strong').attr('x', '-80%').attr('y', '-80%').attr('width', '260%').attr('height', '260%');
  glowStrong.append('feGaussianBlur').attr('stdDeviation', '12').attr('result', 'blur');
  glowStrong.append('feComposite').attr('in', 'blur').attr('in2', 'SourceGraphic').attr('operator', 'over');

  // Pulse animation marker for synaptic signals
  const pulseGrad = defs.append('radialGradient').attr('id', 'pulse-grad');
  pulseGrad.append('stop').attr('offset', '0%').attr('stop-color', '#fff').attr('stop-opacity', 0.9);
  pulseGrad.append('stop').attr('offset', '100%').attr('stop-color', '#fff').attr('stop-opacity', 0);

  const g = svg.append('g');
  const zoom = d3.zoom()
    .scaleExtent([0.2, 4])
    .on('zoom', (e) => g.attr('transform', e.transform));
  svg.call(zoom);

  const galaxies = DATA.galaxies || [];
  const bridges = DATA.bridges || [];
  const nodes = [];
  const links = [];

  // Galaxy center nodes
  galaxies.forEach(gal => {
    nodes.push({ id: gal.id, name: gal.name, color: gal.color, isGalaxy: true, count: gal.count, members: gal.members });
  });

  // Item nodes
  const itemGalaxyMap = {};
  galaxies.forEach(gal => {
    gal.members.forEach(mid => {
      if (!itemGalaxyMap[mid]) itemGalaxyMap[mid] = [];
      itemGalaxyMap[mid].push(gal.id);
    });
  });

  DATA.items.forEach(item => {
    const nodeId = 'item-' + item._id;
    const galIds = itemGalaxyMap[item._id] || [];
    const gal = galaxies.find(g => g.id === galIds[0]);
    nodes.push({ id: nodeId, title: item.title || item.domain, color: gal ? gal.color : '#9C948A', isGalaxy: false, item, galaxyIds: galIds, isBridge: galIds.length > 1 });
    // Link to primary galaxy
    if (galIds.length > 0) {
      links.push({ source: galIds[0], target: nodeId, strength: 1 });
    }
    // Weaker links to secondary galaxies
    galIds.slice(1).forEach(gid => {
      links.push({ source: gid, target: nodeId, strength: 0.3 });
    });
  });

  // Bridge links between galaxies
  bridges.forEach(b => {
    links.push({ source: b.source, target: b.target, strength: b.strength * 0.5, isBridge: true });
  });

  // Related links between items
  DATA.items.forEach(item => {
    if (item.related) {
      item.related.forEach(rel => {
        const target = DATA.items.find(i => i.link === rel.url);
        if (target) {
          links.push({ source: 'item-' + item._id, target: 'item-' + target._id, strength: 0.5, isRelated: true });
        }
      });
    }
  });

  // Relation links (tag co-occurrence) - visual only, no force
  const relSet = new Set();
  const weakLinks = [];
  (DATA.relations || []).forEach(r => {
    const key = r.source < r.target ? r.source + '-' + r.target : r.target + '-' + r.source;
    if (!relSet.has(key)) {
      relSet.add(key);
      weakLinks.push({ source: 'item-' + r.source, target: 'item-' + r.target, strength: Math.min(r.strength, 3) * 0.1, isWeak: true });
    }
  });
  const allLinks = [...links, ...weakLinks];

  const simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
      if (d.isBridge) return 180;
      if (d.isRelated) return 100;
      return d.strength < 1 ? 120 : 75;
    }).strength(d => d.isBridge ? 0.06 : d.isRelated ? 0.15 : 0.25))
    .force('charge', d3.forceManyBody().strength(d => d.isGalaxy ? -900 : -180))
    .force('center', d3.forceCenter(width / 2, height / 2).strength(0.015))
    .force('collision', d3.forceCollide().radius(d => d.isGalaxy ? 40 : 25));

  // Galaxy halos ‚Äî soft nebula glow on dark background
  const halo = g.append('g').selectAll('circle').data(nodes.filter(d => d.isGalaxy)).join('circle')
    .attr('r', d => 25 + d.count * 5)
    .attr('fill', d => d.color)
    .attr('fill-opacity', 0.05)
    .attr('stroke', 'none')
    .attr('filter', 'url(#glow-strong)');

  // Second halo layer ‚Äî tighter, slightly brighter core
  const haloInner = g.append('g').selectAll('circle').data(nodes.filter(d => d.isGalaxy)).join('circle')
    .attr('r', d => 12 + d.count * 2)
    .attr('fill', d => d.color)
    .attr('fill-opacity', 0.08)
    .attr('stroke', 'none')
    .attr('filter', 'url(#glow)');

  // Links - render all (including weak for visual)
  const link = g.append('g').selectAll('line').data(allLinks).join('line')
    .attr('stroke', d => d.isRelated ? '#c0845e' : d.isBridge ? '#b8a060' : d.isWeak ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.4)')
    .attr('stroke-width', d => d.isRelated ? 0.8 : d.isBridge ? 0.8 : d.isWeak ? 0.15 : 0.3)
    .attr('stroke-opacity', d => d.isRelated ? 0.25 : d.isBridge ? 0.2 : d.isWeak ? 0.06 : 0.1)
    .attr('stroke-dasharray', d => d.isRelated ? '4,3' : d.isBridge ? '6,4' : 'none');

  // Nodes
  const node = g.append('g').selectAll('g').data(nodes).join('g')
    .attr('class', d => d.isGalaxy ? 'node galaxy-node' : d.isBridge ? 'node bridge-node' : 'node item-node')
    .call(d3.drag().on('start', ds).on('drag', dr).on('end', de));

  graphNodes = node;

  // Galaxy center - glowing core
  node.filter(d => d.isGalaxy).append('circle')
    .attr('r', 5)
    .attr('fill', d => d.color)
    .attr('fill-opacity', 0.8)
    .attr('filter', 'url(#glow)');

  // Galaxy labels - text with glow for readability on dark bg
  node.filter(d => d.isGalaxy).append('text')
    .attr('class', 'node-label theme-label')
    .attr('text-anchor', 'middle')
    .attr('dy', -14)
    .text(d => d.name)
    .style('font-size', '11px')
    .style('fill', d => d.color)
    .style('font-weight', '600')
    .style('opacity', 0.85)
    .style('filter', 'drop-shadow(0 0 6px rgba(0,0,0,0.8))');

  // Galaxy count ‚Äî small subtitle under label
  node.filter(d => d.isGalaxy).append('text')
    .attr('text-anchor', 'middle')
    .attr('dy', 18)
    .text(d => d.count + ' articles')
    .style('font-size', '8px')
    .style('fill', 'rgba(255,255,255,0.3)')
    .style('font-family', "'Source Serif 4', serif")
    .style('pointer-events', 'none')
    .style('letter-spacing', '0.05em');

  // Item circles - neurons with soft glow
  node.filter(d => !d.isGalaxy).append('circle')
    .attr('r', d => d.isBridge ? 6 : 4)
    .attr('fill', d => d.color)
    .attr('fill-opacity', d => d.isBridge ? 0.9 : 0.7)
    .attr('filter', 'url(#glow)');

  // Neuron outer ring - subtle halo
  node.filter(d => !d.isGalaxy).append('circle')
    .attr('r', d => d.isBridge ? 10 : 7)
    .attr('fill', 'none')
    .attr('stroke', d => d.color)
    .attr('stroke-width', 0.5)
    .attr('stroke-opacity', 0.25);

  // Item labels (only show on hover via CSS, or for bridge nodes)
  node.filter(d => !d.isGalaxy).append('text')
    .attr('class', 'node-label')
    .attr('dx', 10).attr('dy', 3)
    .text(d => (d.title || '').slice(0, 16))
    .style('opacity', d => d.isBridge ? 0.8 : 0);

  // Hover: show label + synaptic pulse
  const pulseLayer = g.append('g').attr('class', 'pulse-layer');

  node.filter(d => !d.isGalaxy)
    .on('mouseenter', function(e, d) {
      d3.select(this).select('text').style('opacity', 1);
      // Brighten connected links
      link.transition().duration(300)
        .attr('stroke-opacity', l => {
          const sId = typeof l.source === 'object' ? l.source.id : l.source;
          const tId = typeof l.target === 'object' ? l.target.id : l.target;
          if (sId === d.id || tId === d.id) return l.isRelated ? 0.7 : 0.4;
          return l.isRelated ? 0.06 : l.isBridge ? 0.04 : l.isWeak ? 0.01 : 0.02;
        });
      // Fire pulses along connected links
      const connected = links.filter(l => {
        const sId = typeof l.source === 'object' ? l.source.id : l.source;
        const tId = typeof l.target === 'object' ? l.target.id : l.target;
        return (sId === d.id || tId === d.id) && !l.isWeak;
      });
      connected.forEach((l, i) => {
        const src = typeof l.source === 'object' ? l.source : nodes.find(n => n.id === l.source);
        const tgt = typeof l.target === 'object' ? l.target : nodes.find(n => n.id === l.target);
        if (!src || !tgt) return;
        const fromMe = (typeof l.source === 'object' ? l.source.id : l.source) === d.id;
        const p = pulseLayer.append('circle').attr('r', 2).attr('fill', d.color).attr('fill-opacity', 0.9).attr('filter', 'url(#glow)');
        p.attr('cx', fromMe ? src.x : tgt.x).attr('cy', fromMe ? src.y : tgt.y)
          .transition().duration(600).delay(i * 40)
          .attr('cx', fromMe ? tgt.x : src.x).attr('cy', fromMe ? tgt.y : src.y)
          .attr('fill-opacity', 0)
          .remove();
      });
    })
    .on('mouseleave', function(e, d) {
      if (!d.isBridge) d3.select(this).select('text').style('opacity', 0);
      link.transition().duration(400)
        .attr('stroke-opacity', l => l.isRelated ? 0.25 : l.isBridge ? 0.2 : l.isWeak ? 0.06 : 0.1);
      pulseLayer.selectAll('circle').remove();
    });

  // Click handlers - in-place zoom + fade, no page switch
  let focusMode = null; // null | 'galaxy' | 'item'
  let focusTarget = null;

  function resetFocus() {
    focusMode = null;
    focusTarget = null;
    const t = d3.transition().duration(600).ease(d3.easeCubicOut);
    node.transition(t).style('opacity', 1);
    node.filter(d => !d.isGalaxy).select('text').transition(t).style('opacity', d => d.isBridge ? 0.8 : 0);
    node.filter(d => !d.isGalaxy).select('circle').transition(t).attr('r', d => d.isBridge ? 7 : 5);
    link.transition(t).attr('stroke-opacity', d => d.isRelated ? 0.25 : d.isBridge ? 0.2 : 0.1);
    halo.transition(t).style('opacity', 1);
    haloInner.transition(t).style('opacity', 1);
    svg.transition().duration(800).ease(d3.easeCubicOut).call(zoom.transform, d3.zoomIdentity);
    renderList();
  }

  function focusGalaxy(galNode) {
    focusMode = 'galaxy';
    focusTarget = galNode;
    const memberIds = new Set(galNode.members.map(m => 'item-' + m));
    const t = d3.transition().duration(600).ease(d3.easeCubicOut);
    node.transition(t).style('opacity', d => {
      if (d.id === galNode.id) return 1;
      if (memberIds.has(d.id)) return 1;
      if (d.isGalaxy) return 0.12;
      return 0.06;
    });
    node.filter(d => !d.isGalaxy).select('text').transition(t).style('opacity', d => memberIds.has(d.id) ? 1 : 0);
    node.filter(d => !d.isGalaxy).select('circle').transition(t).attr('r', d => memberIds.has(d.id) ? 9 : 3);
    link.transition(t).attr('stroke-opacity', d => {
      const sId = typeof d.source === 'object' ? d.source.id : d.source;
      const tId = typeof d.target === 'object' ? d.target.id : d.target;
      if (sId === galNode.id || tId === galNode.id) return 0.6;
      if (memberIds.has(sId) && memberIds.has(tId)) return 0.5;
      return 0.02;
    });
    halo.transition(t).style('opacity', d => d.id === galNode.id ? 1 : 0.08);
    haloInner.transition(t).style('opacity', d => d.id === galNode.id ? 1 : 0.08);
    const scale = 2;
    const tx = width / 2 - galNode.x * scale;
    const ty = height / 2 - galNode.y * scale;
    svg.transition().duration(800).ease(d3.easeCubicOut).call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
    const gal = (DATA.galaxies || []).find(g => g.id === galNode.id);
    if (gal) showThemeDetail(gal, DATA.items.filter(i => gal.members.includes(i._id)));
  }

  function focusItem(itemNode) {
    focusMode = 'item';
    focusTarget = itemNode;
    const t = d3.transition().duration(600).ease(d3.easeCubicOut);
    const connectedIds = new Set([itemNode.id]);
    if (itemNode.item && itemNode.item.related) {
      itemNode.item.related.forEach(r => {
        const target = DATA.items.find(i => i.link === r.url);
        if (target) connectedIds.add('item-' + target._id);
      });
    }
    DATA.items.forEach(i => {
      if (i.related && i.related.some(r => r.url === itemNode.item.link)) connectedIds.add('item-' + i._id);
    });
    const galIds = itemNode.galaxyIds || [];
    galIds.forEach(gid => {
      connectedIds.add(gid);
      const gal = (DATA.galaxies || []).find(g => g.id === gid);
      if (gal) gal.members.forEach(m => connectedIds.add('item-' + m));
    });
    node.transition(t).style('opacity', d => connectedIds.has(d.id) ? 1 : 0.05);
    node.filter(d => !d.isGalaxy).select('text').transition(t).style('opacity', d => connectedIds.has(d.id) ? 1 : 0);
    node.filter(d => !d.isGalaxy).select('circle').transition(t).attr('r', d => d.id === itemNode.id ? 12 : connectedIds.has(d.id) ? 8 : 3);
    link.transition(t).attr('stroke-opacity', d => {
      const sId = typeof d.source === 'object' ? d.source.id : d.source;
      const tId = typeof d.target === 'object' ? d.target.id : d.target;
      if (connectedIds.has(sId) && connectedIds.has(tId)) return 0.6;
      return 0.01;
    });
    halo.transition(t).style('opacity', d => galIds.includes(d.id) ? 0.5 : 0.04);
    haloInner.transition(t).style('opacity', d => galIds.includes(d.id) ? 0.5 : 0.04);
    const scale = 2.5;
    const tx = width / 2 - itemNode.x * scale;
    const ty = height / 2 - itemNode.y * scale;
    svg.transition().duration(800).ease(d3.easeCubicOut).call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
    showDetail(itemNode.item);
  }

  node.on('click', (e, d) => {
    e.stopPropagation();
    if (d.isGalaxy) {
      if (focusMode === 'galaxy' && focusTarget && focusTarget.id === d.id) resetFocus();
      else focusGalaxy(d);
    } else {
      if (focusMode === 'item' && focusTarget && focusTarget.id === d.id) resetFocus();
      else focusItem(d);
    }
  });

  svg.on('click', () => { if (focusMode) resetFocus(); else renderList(); });

  // Node lookup for weak links (not in simulation)
  const nodeMap = {};
  nodes.forEach(n => nodeMap[n.id] = n);
  weakLinks.forEach(l => { l.source = nodeMap[l.source] || l.source; l.target = nodeMap[l.target] || l.target; });

  simulation.on('tick', () => {
    halo.attr('cx', d => d.x).attr('cy', d => d.y);
    haloInner.attr('cx', d => d.x).attr('cy', d => d.y);
    link.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
    node.attr('transform', d => `translate(${d.x},${d.y})`);
  });

  // Breathing: keep simulation gently alive
  simulation.alphaDecay(0.02).alphaMin(0.005).alphaTarget(0.008).restart();

  // Auto-fit after layout stabilizes
  setTimeout(() => {
    const xs = nodes.map(n => n.x), ys = nodes.map(n => n.y);
    const x0 = Math.min(...xs) - 40, x1 = Math.max(...xs) + 40;
    const y0 = Math.min(...ys) - 40, y1 = Math.max(...ys) + 40;
    const bw = x1 - x0, bh = y1 - y0;
    const scale = Math.min(width / bw, height / bh, 1.5) * 0.9;
    const tx = width / 2 - (x0 + bw / 2) * scale;
    const ty = height / 2 - (y0 + bh / 2) * scale;
    svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
  }, 2000);

  // Ambient synaptic pulses - random signals firing in background
  const ambientLayer = g.append('g').attr('class', 'ambient-pulses');
  function fireAmbientPulse() {
    const visibleLinks = links.filter(l => !l.isWeak && l.source.x != null);
    if (visibleLinks.length === 0) return;
    const l = visibleLinks[Math.floor(Math.random() * visibleLinks.length)];
    const src = l.source, tgt = l.target;
    if (!src.x || !tgt.x) return;
    const color = src.color || tgt.color || '#ffffff';
    ambientLayer.append('circle').attr('r', 1.5).attr('fill', color).attr('fill-opacity', 0.5)
      .attr('cx', src.x).attr('cy', src.y)
      .transition().duration(800 + Math.random() * 400)
      .attr('cx', tgt.x).attr('cy', tgt.y)
      .attr('fill-opacity', 0)
      .remove();
  }
  setInterval(fireAmbientPulse, 300);

  function ds(e) { if (!e.active) simulation.alphaTarget(0.3).restart(); e.subject.fx = e.subject.x; e.subject.fy = e.subject.y; }
  function dr(e) { e.subject.fx = e.x; e.subject.fy = e.y; }
  function de(e) { if (!e.active) simulation.alphaTarget(0.008); e.subject.fx = null; e.subject.fy = null; }
}

</script>
</body>
</html>
